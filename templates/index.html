<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generador de Diagramas de Clases en Python</title>

    <!-- Tailwind + fuentes -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <!-- Configuración de Tailwind (colores iguales a tu versión moderna) -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#2D0A73",
                        "background-light": "#F7F8FA",
                        "background-dark": "#1F2937"
                    },
                    fontFamily: {
                        display: "Space Grotesk"
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>

    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
        }

        pre {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .CodeMirror {
        height: 100% !important;
        }

        .dot-container-empty {
        background: #1e1e1e; 
        color: #ccc;
        border-radius: 0.5rem;
        padding: 1rem;
        height: 100% !important;   
        overflow: auto;
        font-family: monospace;
        }

        .code-scroll {
            overflow: auto;
            scrollbar-width: thin;          
            scrollbar-color: #555 transparent;
        }

        .code-scroll::-webkit-scrollbar {
            height: 5px;
            width: 6px;
        }

        .code-scroll::-webkit-scrollbar-thumb {
            background: #3f3f46; 
            border-radius: 10px;
        }

        .code-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        #diagram {
            height: 100% !important;           
            width: 100%;
            overflow: hidden;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;

            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
    </style>
    <script src="https://unpkg.com/viz.js@2.1.2/viz.js"></script>
    <script src="https://unpkg.com/viz.js@2.1.2/full.render.js"></script>

    <!-- CodeMirror 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/yonce.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>


</head>

<body class="bg-primary font-display">
<div class="relative flex min-h-screen w-full flex-col font-display overflow-hidden">
    <header class="flex items-center justify-center px-6 py-4 bg-purple-900 shadow-md">
        <h1 class="text-white text-xl md:text-3xl font-bold leading-tight">Generador de Diagramas de Clases</h1>
    </header>

    <main class="flex-1 grid grid-cols-1 md:grid-cols-3 min-h-0">
        <div class="flex flex-col gap-4 p-6 overflow-y-auto">
            <h2 class="text-white text-lg font-bold leading-tight">Código Python</h2>
            <form action="/" method="post" class="flex flex-col flex-1">
                <textarea id="code" name="code" required class="hidden">{{ code }}</textarea>
                <div id="codeEditor" class="h-[73vh] rounded-lg overflow-hidden code-scroll"></div>


                <button type="submit"
                    class="mt-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white py-2 font-bold transition-colors">
                    Generar Diagrama
                </button>

                {% if error %}
                    <div id="toast"
                        class="fixed top-6 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999]
                                animate-[fadeIn_0.3s_ease-out]">
                        <span class="font-semibold">⚠ Error:</span> {{ error }}
                    </div>

                    <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translate(-50%, -10px); }
                        to   { opacity: 1; transform: translate(-50%, 0); }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; transform: translate(-50%, 0); }
                        to   { opacity: 0; transform: translate(-50%, -10px); }
                    }
                    </style>

                    <script>
                    // El toast se desvanece a los 4 segundos
                    setTimeout(() => {
                        const t = document.getElementById("toast");
                        if (t) {
                            t.style.animation = "fadeOut 0.4s forwards";
                            setTimeout(() => t.remove(), 400);
                        }
                    }, 4000);
                    </script>
                    {% endif %}
            </form>
        </div>
        <div class="flex flex-col gap-4 p-6 overflow-y-auto">
            <h2 class="text-white text-lg font-bold leading-tight">Archivo generado (.dot)</h2>
            <div class="flex-1">
                {% if dot_content %}
                    <textarea id="dotRaw" class="h-[80vh] hidden">{{ dot_content }}</textarea>
                    <div id="dotEditor" class="h-[80vh] rounded-lg overflow-hidden code-scroll"></div>
                {% else %}
                    <div class="dot-container-empty">
                        <p class="text-neutral-500">Tu archivo .dot aparecerá aquí.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="flex flex-col gap-4 p-6 overflow-y-auto">
            <div class="flex justify-between items-center">
                <h2 class="text-white text-lg font-bold leading-tight">Diagrama de Clases</h2>
                <div class="flex items-center gap-1">
                    <button id="zoomIn" class="flex items-center justify-center size-8 rounded-md bg-white/20 hover:bg-white/30 text-white transition-colors">
                        <span class="material-symbols-outlined text-xl">zoom_in</span>
                    </button>
                    <button id="zoomOut" class="flex items-center justify-center size-8 rounded-md bg-white/20 hover:bg-white/30 text-white transition-colors">
                        <span class="material-symbols-outlined text-xl">zoom_out</span>
                    </button>
                    <button id="resetZoom" class="flex items-center justify-center size-8 rounded-md bg-white/20 hover:bg-white/30 text-white transition-colors">
                        <span class="material-symbols-outlined text-xl">restart_alt</span>
                    </button>
                </div>
            </div>

            <div id="diagram" class="items-center justify-center rounded-lg border border-neutral-200 bg-white p-4">
                {% if dot_content %}
                    <!-- Diagrama renderizado aquí -->
                {% else %}
                    <div class="flex flex-col items-center gap-6 text-center">
                        <span class="material-symbols-outlined text-5xl text-primary">schema</span>
                        <p class="text-neutral-900 text-lg font-medium">Tu diagrama aparecerá aquí.</p>
                        <p class="text-neutral-500 text-sm">Pega tu código y presiona "Generar Diagrama".</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>

{% if dot_content %}
<script>
    const dot = {{ dot_content | tojson }};
    const viz = new Viz();
    const diagramDiv = document.getElementById("diagram");
    let currentZoom = 1.0;
    function renderDiagram() {
        viz.renderSVGElement(dot)
            .then(svg => {
                svg.style.transform = `translate(-50%, -50%) scale(${currentZoom})`;
                svg.style.transformOrigin = "top left";
                svg.style.position = "absolute";
                svg.style.left = "50%";
                svg.style.top = "50%";
                svg.style.cursor = "grab";
                diagramDiv.innerHTML = "";
                diagramDiv.appendChild(svg);
            })
            .catch(err => {
                console.error(err);
                diagramDiv.innerText = "Error al renderizar el diagrama.";
            });
    }
    renderDiagram();
    document.getElementById("zoomIn").addEventListener("click", () => {
        currentZoom += 0.1;
        renderDiagram();
    });
    document.getElementById("zoomOut").addEventListener("click", () => {
        currentZoom = Math.max(0.1, currentZoom - 0.1);
        renderDiagram();
    });
    document.getElementById("resetZoom").addEventListener("click", () => {
        currentZoom = 1.0;
        renderDiagram();
    });
</script>

<script>
    const dotEditor = CodeMirror(document.getElementById("dotEditor"), {
        value: document.getElementById("dotRaw").value,
        mode: "text/vnd.graphviz",      
        theme: "yonce",
        lineNumbers: true,
        readOnly: true,         
        viewportMargin: Infinity
    });
</script>
{% endif %}

<script>
    const editor = CodeMirror(document.getElementById("codeEditor"), {
        value: document.getElementById("code").value,
        mode: "python",
        theme: "yonce",
        lineNumbers: true,
        autoCloseBrackets: true,
        indentUnit: 4,
        tabSize: 4
    });

    // Sincroniza el contenido con el textarea oculto
    editor.on("change", () => {
        document.getElementById("code").value = editor.getValue();
    });
</script>

<script>
editor.on("change", () => {
    const txt = editor.getValue().trim();
    document.getElementById("code").value = txt;

    if (txt === "") {
        // borrar .dot
        document.getElementById("dotEditor").innerHTML = `<div class="dot-container-empty">
                                                            <p class="text-neutral-500">Tu archivo .dot aparecerá aquí.</p>
                                                        </div>`;

        // borrar diagrama
        document.getElementById("diagram").innerHTML = `
            <div class="flex flex-col items-center gap-3 text-center">
                <span class="material-symbols-outlined text-5xl text-primary">schema</span>
                <p class="text-neutral-900 text-lg font-medium">Tu diagrama aparecerá aquí.</p>
                <p class="text-neutral-500 text-sm">Pega tu código y presiona "Generar Diagrama".</p>
            </div>
        `;
    }
});
</script>

<script>
    let isPanning = false;
    let startX, startY;
    let originX = 0, originY = 0;

    diagramDiv.addEventListener("mousedown", e => {
        isPanning = true;
        diagramDiv.style.cursor = "grabbing";
        startX = e.clientX - originX;
        startY = e.clientY - originY;
    });

    document.addEventListener("mouseup", () => {
        isPanning = false;
        diagramDiv.style.cursor = "grab";
    });

    document.addEventListener("mousemove", e => {
        if (!isPanning) return;
        originX = e.clientX - startX;
        originY = e.clientY - startY;
        diagramDiv.firstChild.style.transform = 
            `translate(${originX}px, ${originY}px) scale(${currentZoom})`;
    });
</script>


</body>
</html>